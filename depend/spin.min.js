class Spinner {
    dom = null

    _opts = {
        color: '#FFFFFF', // 花瓣颜色
        petalRadius: 6, // 花瓣半径
        internalRadius: 16, // 内径
        petalSum: 10, // 花瓣数量
    }

    constructor(opts) {
        this._opts = this._structureAssignment(this._opts, opts, true)

        console.log('spin constructor', this._opts)
    }

    spin(target) {
        this.stop()

        if (target == null) {
            return
        }

        let color = this._opts.color
        let petal_radius = this._opts.petalRadius
        let inside_radius = this._opts.internalRadius
        let petal_sum = this._opts.petalSum

        let id = $(target).attr('id')
        let root = '<div id="' + id + '_spin_root">[con]</div>'
        let run = '<div class="lds-spinner" id="' + id + '_lds_spin">[con]</div>'
        let view_petal = ''

        for (let i = 0; i < petal_sum; i++) {
            view_petal += '<div class="' + id + '_petal"></div>'
        }

        $(target).html(root.replace('[con]', run.replace('[con]', view_petal)))

        // 设置样式
        this.dom = $('#' + id + '_spin_root') // 根视图对象

        this.dom.css({
            'display': 'flex',
            'justify-content': 'center',
            'align-items': 'center',
            'width': '100%',
            'height': 'auto',
            'box-sizing': 'border-box'
        })

        let rW = (petal_radius * 2 + inside_radius) * 2
        let rH = (petal_radius * 2 + inside_radius) * 2
        let pW = petal_radius * 2
        let pH = petal_radius * 2
        let pTop = (rH - pH) / 2
        let xOffset = (rW / 2)
        let yOffset = (rH / 2) - pTop
        let originTran = xOffset + 'px ' + yOffset + 'px'

        $('#' + id + '_lds_spin').css({
            'position': 'relative',
            'width': rW + 'px',
            'height': rH + 'px'
        })

        $('.' + id + '_petal').css({
            'left': '0px',
            'top': pTop + 'px',
            'position': 'absolute',
            'width': pW + 'px',
            'height': pH + 'px',
            'border-radius': '50%',
            'transform-origin': originTran,
            '-webkit-transform-origin': originTran,
            'background': color
        })

        let rotateIncrement = 360 / petal_sum

        let timeIncrement = 1 / petal_sum

        for (let i = 0; i < petal_sum; i++) {
            let index = i + 1

            let deg = (rotateIncrement * index) - rotateIncrement

            let time = (timeIncrement * index) - 1

            time = time.toFixed(2)

            $('.lds-spinner div:nth-child(' + index + ')').css({
                'transform': 'rotate(' + deg + 'deg)',
                '-webkit-transform': 'rotate(' + deg + 'deg)',
                'animation': 'lds-spinner linear 1s infinite',
                '-webkit-animation': 'lds-spinner linear 1s infinite',
                'animation-delay': time + 's',
                '-webkit-animation-delay': time + 's'
            })
        }
    }

    stop() {
        if (this.dom != null) {
            this.dom.remove()
            this.dom = null

            console.log('spin for stop')
        }
    }

    /**
     * 对象赋值
     * _opts : 属性接收对象
     * _newopts : 属性赋值对象
     */
    _structureAssignment(_opts, _newopts, isIdentical) {
        console.log('structureAssignment opts', _opts, ' nweopts', _newopts)

        if (_newopts == null) {
            return _opts
        }

        if (isIdentical == null) {
            isIdentical = true
        }

        if (_newopts instanceof Array) {
            return _opts
        } else if (_newopts instanceof Object) {
            Object.keys(_newopts).forEach(function (key) {
                if (key in _opts) { // 判断是否存在该属性
                    if (isIdentical) {
                        if (_opts[key] == null) {
                            _opts[key] = _newopts[key]
                        } else if (typeof (_opts[key]) == typeof (_newopts[key])) {
                            _opts[key] = _newopts[key]
                        }
                    } else {
                        _opts[key] = _newopts[key]
                    }
                }
            })

            return _opts
        } else {
            return _opts
        }
    }
}